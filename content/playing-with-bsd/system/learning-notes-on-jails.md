---
title: "Learning Notes on FreeBSD Jails"
date: 2018-10-07T18:35:49+09:00
lastmod: 2018-12-14T20:42:00+09:00
draft: false
tags: [ "freebsd", "jail", "virtualization", "administration" ]
toc: true
---
I have heard about jails many times since my early days of FreeBSD life but it was only the last year I began to use it in production.

This article is a sort of personal notebook where I summarize what I learned about jails. It would be frequently updated as I learn more.

## Assumptions
* The host is running FreeBSD 11.2/amd64 on ZFS.
* Each jail has a separate root dataset under /vm on the host.
* Template datasets are created under /vm/tmpl like /vm/tmpl/11.2.
* Jails are generated by cloning or send/receive(copying) a template dataset.
* Jails are configured through system-standard /etc/jail.conf.  
(There's nothing wrong with tools like iocage. But after using them for a while I realized standard toolset is good enough for simple environments like mine. It also gives me a clearer view of what's going on and seems more suited for learning.)
* User login shell on the host is bash while root shell is tcsh.  
(I changed my login shell to bash the last year after using tsch for decades. It's not also a tcsh's fault. I just wanted to learn more about shell scripting even in the daily, interactive sessions.)
* Sudo is used to run commands with superuser privilege.
* For standard (non-VNET) jails, their IP addresses are assigned to the loopback interface "lo1". They are translated to/from the host's external IP address by pf's NAT feature.
* Inspired by [Devin Teske's talk](https://www.youtube.com/watch?v=aoW7pWuhT_A), I'm also experimenting VNET (IMAGE) jails. For VNET jails, netgraph is used to build virtual network/switch instead of if_bridge and epair which seem to be more popular.

## Creating a Template
When you start using jails, the first thing to do is creating a template for future jails.

1. Create ZFS datasets for jails and templates.  
Here I'm going to create a FreeBSD 11.2 template in /vm/tmpl/11.2.

	```
	sudo zfs create -o mountpoint=/vm zroot/vm
	sudo zfs create zroot/vm/tmpl
	sudo zfs create zroot/vm/tmpl/11.2
	```

2. Download a base install set tarball for FreeBSD 11.2 release.

	```
	cd ~/tmp
	fetch ftp:/ftp.freebsd.org/pub/FreeBSD/releases/amd64/11.2-RELEASE/base.txz
	```

3. Extract the base tarball in the template directory.

	```
	sudo tar -xJvpf base.txz -C /vm/tmpl/11.2
	```

4. Copy timezone configuration from the host to the template.  
Usually /etc/resolv.conf is also copied from the host, but after some experiments I decided to copy it by using /etc/jail.conf's exec.prestart and delete it by exec.poststop.

	```
	sudo cp /etc/localtime /vm/tmpl/11.2/etc/
	```

5. Write a minimum /etc/rc.conf for the template.  
Here I disable cron in jails but it might be better to leave it enabled and fine-tune its configurations.  
I need more research on this.

	```
	sudo vi /vm/tmpl/11.2/etc/rc.conf
	```

	```
	cron_enable="NO"
	sendmail_enable="NO"
	sendmail_submit_enable="NO"
	sendmail_outbound_enable="NO"
	sendmail_msp_queue_enable="NO"
	syslogd_flags="-ss"
	```

6. Edit system crontab in the template to disable adjkern.  
Obviously this is not necessary because I disabled cron in the previous step but I do this as a precaution anyway.

	```
	sudo vi /vm/tmpl/11.2/etc/crontab
	```

	```
	#1,31 0-5 * * * root adjkerntz -a
	```

7. Create directories to handle ports in jails.  
The first one is to read-only mount host's ports tree and others are working spaces.  
Also create /etc/make.conf to use the directories for building ports in jails.

	```
	sudo mkdir /vm/tmpl/11.2/usr/ports
	sudo mkdir -p /vm/tmpl/11.2/var/ports/{distfiles,packages}
	sudo vi /vm/tmpl/11.2/etc/make.conf
	```

	```
	WRKDIRPREFIX = /var/ports
	DISTDIR = /var/ports/distfiles
	PACKAGES = /var/ports/packages
	```

8. Apply system updates to the template.

	```
	sudo freebsd-update -b /vm/tmpl/11.2 fetch install
	```

9. Take a snapshot of the template dataset.  
Strictly speaking, a template is a snapshot not a dataset. The snapshot can be cloned or sent/received to generate new datasets for production jails.

	```
	sudo zfs snapshot zroot/vm/tmpl/11.2@p3
	```

## Creating Jails from the Template

Once the template is ready, jails can be created by cloning or sending/receiving its snapshot.  
Usually, I use clone for quick testing while I prefer zfs send/receive for production jails.

### By ZFS Clone
Create four jails h1, h2, h3 and h4 by cloning the 11.2 template's p3 snapshot.
```
for jail in h1 h2 h3 h4; do
    sudo zfs clone zroot/vm/tmpl/11.2@p3 zroot/vm/$jail
done
```

### By ZFS Send/Receive
Create four jails h1, h2, h3 and h4 by sending/receiving the 11.2 template's p3 snapshot.
```
for jail in h1 h2 h3 h4; do
    sudo sh -c "zfs send zroot/vm/tmpl/11.2@p3 | zfs receive zroot/vm/$jail"
done
```

## Configuring Jails

### System Startup Configuration
Do not forget to create a cloned loopback interface "lo1" on which jail's addresses are configured.

PF is used for NAT and port forwarding.

[/etc/rc.conf]
```
cloned_interfaces="lo1"
pf_enable="YES"
pflog_enable="YES"
jail_enable="YES"
jail_list="h1 h2 h3 h4"
```

### System Jail Configuration
[/etc/jail.conf]
```
exec.start = "/bin/sh /etc/rc";
exec.stop = "/bin/sh /etc/rc.shutdown";
exec.clean;
mount.devfs;

host.hostname = $name;
path = "/vm/$name";
exec.consolelog = "/var/log/jail_${name}_console.log";
exec.prestart = "cp /etc/resolv.conf $path/etc";
exec.poststop = "rm $path/etc/resolv.conf";

# nullfs mount
h1 {
        ip4.addr = "lo1|127.1.1.1/32";
        ip6.addr = "lo1|fd00:1:1:1::1/64";
        allow.chflags;
        allow.raw_sockets;
        mount.fstab = "/vm/${name}.fstab";
}

# WINE (sysvsem)
h2 {
        ip4.addr = "lo1|127.1.1.2/32";
        ip6.addr = "lo1|fd00:1:1:1::2/64";
        allow.chflags;
        allow.raw_sockets;
        sysvsem = "new";
}

# PostgreSQL (sysvsem, sysvshm)
h3 {
        ip4.addr = "lo1|127.1.1.3/32";
        ip6.addr = "lo1|fd00:1:1:1::3/64";
        allow.chflags;
        allow.raw_sockets;
        sysvsem = "new";
        sysvshm = "new";
}

# Java (fdescfs, procfs)
h4 {
        ip4.addr = "lo1|127.1.1.4/32";
        ip6.addr = "lo1|fd00:1:1:1::4/64";
        allow.chflags;
        allow.raw_sockets;
        mount.fdescfs;
        mount.procfs;
}
```

### Per-Jail fstab
[/vm/h1.fstab]
```
/usr/ports /vm/h1/usr/ports nullfs ro 0 0
```

### NAT Configuration
PF configuration should be written in the strict order of categories.

For IPv6 NAT, I explicitly specify a external (global) address instead of the interface name because an IPv6 interface usually has multiple addresses and it seems the interface name could be resolved to its link-local address.

[/etc/pf.conf]
```
# MACROS/TABLES
XIF = "em0"
JAILNET_V4 = "127.1.1.0/24"
JAILNET_V6 = "fd00:1:1:1::0/64"
EXT_V6ADDR = "2001:db8::1"

# OPTIONS (set skip, etc.)
# NORMALIZATION (scrub)
# QUEUEING

# TRANSLATION
## NAT
nat on $XIF inet from $JAILNET_V4 to any -> ($XIF)
nat on $XIF inet6 from $JAILNET_V6 to any -> $EXT_V6ADDR

## REDIRECT (Port Forwarding)
rdr pass log on $XIF inet proto tcp to ($XIF) port 8080 -> 127.1.1.4
rdr pass log on $XIF inet6 proto tcp to $EXT_V6ADDR port 8080 -> fd00:1:1:1::4

# FILTERING (Pass/Block)
```

### Hosts Table
[/etc/hosts]
```
127.1.1.1 h1
127.1.1.2 h2
127.1.1.3 h3
127.1.1.4 h4
fd00:1:1:1::1 h1
fd00:1:1:1::2 h2
fd00:1:1:1::3 h3
fd00:1:1:1::4 h4
```

## Managing Jails

Start all jails.

```
sudo service jail start
```

Start specific jail(s).
```
sudo service jail start h1
```

Login to a jail.
```
sudo jexec h1
```

Run a command on a jail.
```
sudo jexec h1 ifconfig
```

List running jails.
```
jls
jls -v
jls -s
```
__NOTE:__ At first I was confused by `ip4=disable` output of `jls -s`. But later I looked at /usr/src/usr.sbin/jls/jls.c and learned that it's correct because ip4's value is 'disable' unless explicitly set otherwise. It's just regarded as 'new' when ip4.addr is set.

Stop specific jail(s).
```
sudo service jail stop h1
```

Stop all jails.
```
sudo service jail stop
```

Manage binary packages on a jail.
```
sudo pkg -j h1 update
sudo pkg -j h1 upgrade
sudp pkg -j h1 install git-lite vim-console
```

Update package repositories on multiple jails using shell's for loop.
```
for jail in $(jls name); do
  sudo pkg -j $jail update
done
```

Apply system updates to a jail.
```
sudo freebsd-update -b /vm/h1 fetch install
```

Upgrade system on a jail.
```
sudo freebsd-update -b /vm/h1 -r 11.3-RELEASE upgrade
```

When you have already upgraded the host, run the following commands in a jail.
```
setenv UNAME_r `freebsd-version`
freebsd-update -r 11.3-RELEASE upgrade
/usr/sbin/freebsd-update install
(No reboot required for a jail)
unsetenv UNAME_r
/usr/sbin/freebsd-update install
```

## VNET Jails
Sometimes I feel that jails networking is not always intuitive.

In my current understanding, a standard (non-VNET) jail shares its IP address with the host.  
If the jail doesn't listen to a specific TCP or UDP port on the address, packets destined to the port/address are processed by the host.  
A jail's address is usually an IP alias (secondary address) on the host but it's not limited to that. Actually a jail can use the host's primary IP address unless the host and the jail doesn't use the same ports.  
I think this behavior is confusing because I expect that the host and jails can be viewed as spearate systems.

It's also hard to understand at first that jail's 127.0.0.1 is mapped to an address deligated to the jail, inter-jail communications go through lo0 even if jails' addresses are assigned to lo1 and so on.

In this regard, VNET jails look simpler to me.  
So I gave it a try despite the fact that they require custom kernel with VIMAGE feature enabled (I completely got used to using binary updates with GENERIC kernel and almost forgot the time when I always rebuilt kernel to slim it down).

_GOOD NEWS! (2018-12-14)  
VIMAGE is enabled by default on FreeBSD 12.0.  
If you are using the version, you don't have to recompile your kernel._

### Installing and Updating FreeBSD Source
#### From Distribution Tarball
```
cd ~/tmp
fetch ftp://ftp.freebsd.org/pub/FreeBSD/releases/amd64/11.2-RELEASE/src.txz
```

Update the source.
```
sudo tar -xJvpf src.txz -C /
```

#### From Subversion
```
sudo svnlite checkout https://svn.freebsd.org/base/releng/11.2 /usr/src
sudo svnlite update /usr/src
```

Update the source.
```
sudo svnlite update /usr/src
```

### Building VIMAGE-enabled Kernel
#### The Simplest Way
Build kernel using a configuration file which comes with the FreeBSD source tree.  
This config file contains some netgraph modules handy for VNET jails.
```
sudo cp /usr/src/share/examples/jails/VIMAGE /usr/src/sys/amd64/conf
cd /usr/src
sudo make KERNCONF=VIMAGE kernel
sudo shutdown -r now
```

#### Minimum Configuration
To add only VIMAGE to GENERIC, create a kernel configuration file with the following content.  
[/usr/src/sys/amd64/conf/VIMAGE]
```
include GENERIC
ident VIMAGE
options VIMAGE
```
Then build.
```
cd /usr/src
sudo make KERNCONF=VIMAGE kernel
sudo shutdown -r now
```

### Preparing Helper Script
I made a quick-and-dirty modification to the jng script in the FreeBSD source tree and named it vnet. This small script is used to setup netgraph-based virtual switch/interfaces for the host and jails.
```
mkdir ~/src
cd ~/src
git clone https://github.com/genneko/freebsd-vimage-jails.git jails
sudo ln -s ~/src/jails/vnet /usr/sbin/
```

### /etc/jail.conf for VNET Jails
Depending on the network configuration, slightly different configuration should be added to /etc/jail.conf for each VNET jail.

#### Bridged Configuration

<pre style="line-height: 10pt"><code style="font-size: 9pt">                      |
                      |
                 +----o----+
                 | gateway |
                 +----o----+
                      | $gwv4/$plen
                      |
+--------+------------+------------------+
         |
     em0 | (ng_ether)
  (=$net)|
+--------|-------------------------------+
|        |                               |
|        | lower +-------------+         |
|        +-------+    em0br    |         |
|        +-------+ (ng_bridge) |         |
|        | upper +---------+---+         |
|        |                 |             |
|        |          em0_b1 | $ipv4/$plen |
|    em0 |     (ng_eiface) |             |
|    +---o---+         +---o---+         |
|    |  Host |         |Jail b1|         |
|    +-------+         +-------+         |
+----------------------------------------+
</code></pre>

For a bridge configuration, $net is the name of a physical ethernet interface (ng_ether) on the host.  
$gwv4 is the IP address of a default gateway for the jail and the host while $ipv4 is the IP address of the jail's virtual interface (ng_eiface).  
$plen is a subnet mask length for the bridged network.  
The jail's virtual interface and the host's physical interface are connected by a ng_bridge named '${net}br'.  
In this configuration, the jail uses the same router (gateway) as the host to go out.

```
b1 {
        $net = "em0";
        $gwv4 = "192.168.1.1";
        $ipv4 = "192.168.1.11";
        $plen = 24;

        vnet;
        vnet.interface = "${net}_$name";
        exec.prestart += "vnet add $net ${net}_$name";
        exec.start    += "ifconfig ${net}_$name $ipv4/$plen";
        exec.start    += "route add default $gwv4";
        exec.poststop += "vnet delete $net ${net}_$name";
}
```

#### Routed Configuration

<pre style="line-height: 10pt"><code style="font-size: 9pt">                      |
                      |
                 +----o----+
                 | gateway |
                 +----o----+
                      |
                      |
+--------+------------+------------------+
         |
Physical |
     I/F |
+--------|-------------------------------+
|    +---o---+                           |
|    |  Host | (Internal gateway)        |
|    +---o---+                           |
|    vi0 | $gwv4/$plen                   |
|(ng_eiface)                             |
|        |       +-------------+         |
|        +-------+    vi0br    |         |
|                | (ng_bridge) |         |
|                +---------+---+         |
|                          |             |
|                   vi0_v1 | $ipv4/$plen |
|              (ng_eiface) |             |
|                      +---o---+         |
|                      |Jail v1|         |
|                      +-------+         |
+----------------------------------------+
</code></pre>

For a routed configuration, $net is the name of an internal virtual ethernet interface (ng_eiface) on the host and could be any name you like. This interface is created by the vnet script if it doesn't exist.  
$gwv4 is the IP address of this internal interface while $ipv4 is the IP address of the jail's virtual interface (another ng_eiface).  
$plen is a subnet mask length for the virtual network.  
The jail and the host's virtual interface are connected by a ng_bridge named '${net}br'.  
In this configuration, the jail use the host as a gateway to the outside world.
```
v1 {
        $net = "vi0";
        $gwv4 = "172.31.0.1";
        $ipv4 = "172.31.0.11";
        $plen = 24;

        vnet;
        vnet.interface = "${net}_$name";
        exec.prestart += "vnet add -4 $gwv4/$plen $net ${net}_$name";
        exec.start += "ifconfig ${net}_$name $ipv4/$plen";
        exec.start += "route add default $gwv4";
        exec.poststop += "vnet delete $net ${net}_$name";
}
```

### Enabling Packet Forwarding on the Host
For a routed configuration, IP packet forwarding should be enabled to allow the jail to go out to the internet.  
IPv4 packet forwarding can be controlled by sysctl variables ``net.inet.ip.forwarding``.  
It can be configured in /etc/sysctl.conf but the following line in /etc/rc.conf looks nicer to me.

[/etc/rc.conf]
```
gateway_enable="YES"
```

For IPv6, use the following configuration.
```
ipv6_gateway_enable="YES"
```

## References
* FreeBSD Handbook: Jails  
https://www.freebsd.org/doc/handbook/jails.html

* SKYFORGE: An Introduction to Jails and Jail Networking  
https://www.skyforge.at/posts/an-introduction-to-jails-and-jail-networking/

* Devops Discoveries: FreeBSD Jails the hard way  
https://clinta.github.io/freebsd-jails-the-hard-way/

* Devin Teske - Jail Networking, MeetBSD 2016  
https://www.youtube.com/watch?v=aoW7pWuhT_A

* Daemon News: All About Netgraph  
https://people.freebsd.org/~julian/netgraph.html

* NetBSD: Introduction to NETGRAPH on FreeBSD Systems (PDF)  
http://www.netbsd.org/gallery/presentations/ast/2012_AsiaBSDCon/Tutorial_NETGRAPH.pdf

* FreeBSD Mastery: ZFS by Michael W. Lucas and Allan Jude  
https://mwl.io/nonfiction/os#fmzfs

* FreeBSD Mastery: Advanced ZFS by Michael W. Lucas and Allan Jude  
https://mwl.io/nonfiction/os#fmaz

* FreeBSD Mastery: Specialty Filesystems by Michael W. Lucas  
https://mwl.io/nonfiction/os#fmsf

* GitHub: genneko/freebsd-vimage-jails  
https://github.com/genneko/freebsd-vimage-jails
